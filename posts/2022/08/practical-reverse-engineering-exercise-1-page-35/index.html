<!DOCTYPE html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="map[name:winterknife]">
<meta name="description" content="Table of Contents  Question Answer  Question Repeat the walk-through by yourself. Draw the stack layout, including parameters and local variables.
Answer Here is the VirusTotal link to the malware sample in question: wship4.dll
And here is the raw disassembly of the DllMain routine as generated by IDA Pro for reference:
.text:10001C60 ; =============== S U B R O U T I N E ======================================= .text:10001C60 .text:10001C60 ; Attributes: bp-based frame ." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://lampreylabs.com/posts/2022/08/practical-reverse-engineering-exercise-1-page-35/" />


    <title>
        
            Practical Reverse Engineering - Exercise 1, Page 35 :: Lamprey Labs 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://lampreylabs.com/main.622439d48fe0092d9a12ec1b2dad86d82d17a4d0840deb6c388737fff1d8cd8b.css">



    <link rel="apple-touch-icon" sizes="180x180" href="https://lampreylabs.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://lampreylabs.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://lampreylabs.com/favicon-16x16.png">
    <link rel="manifest" href="https://lampreylabs.com/site.webmanifest">
    <link rel="mask-icon" href="https://lampreylabs.com/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://lampreylabs.com/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Practical Reverse Engineering - Exercise 1, Page 35">
<meta itemprop="description" content="Table of Contents  Question Answer  Question Repeat the walk-through by yourself. Draw the stack layout, including parameters and local variables.
Answer Here is the VirusTotal link to the malware sample in question: wship4.dll
And here is the raw disassembly of the DllMain routine as generated by IDA Pro for reference:
.text:10001C60 ; =============== S U B R O U T I N E ======================================= .text:10001C60 .text:10001C60 ; Attributes: bp-based frame ."><meta itemprop="datePublished" content="2022-08-24T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-08-24T00:00:00+00:00" />
<meta itemprop="wordCount" content="1321"><meta itemprop="image" content="https://lampreylabs.com/"/>
<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://lampreylabs.com/"/>

<meta name="twitter:title" content="Practical Reverse Engineering - Exercise 1, Page 35"/>
<meta name="twitter:description" content="Table of Contents  Question Answer  Question Repeat the walk-through by yourself. Draw the stack layout, including parameters and local variables.
Answer Here is the VirusTotal link to the malware sample in question: wship4.dll
And here is the raw disassembly of the DllMain routine as generated by IDA Pro for reference:
.text:10001C60 ; =============== S U B R O U T I N E ======================================= .text:10001C60 .text:10001C60 ; Attributes: bp-based frame ."/>




    <meta property="og:title" content="Practical Reverse Engineering - Exercise 1, Page 35" />
<meta property="og:description" content="Table of Contents  Question Answer  Question Repeat the walk-through by yourself. Draw the stack layout, including parameters and local variables.
Answer Here is the VirusTotal link to the malware sample in question: wship4.dll
And here is the raw disassembly of the DllMain routine as generated by IDA Pro for reference:
.text:10001C60 ; =============== S U B R O U T I N E ======================================= .text:10001C60 .text:10001C60 ; Attributes: bp-based frame ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lampreylabs.com/posts/2022/08/practical-reverse-engineering-exercise-1-page-35/" /><meta property="og:image" content="https://lampreylabs.com/"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-24T00:00:00+00:00" />
<meta property="og:see_also" content="https://lampreylabs.com/posts/2022/08/practical-reverse-engineering-exercise-2-page-35/" /><meta property="og:see_also" content="https://lampreylabs.com/posts/2022/07/practical-reverse-engineering-exercise-4-page-17/" /><meta property="og:see_also" content="https://lampreylabs.com/posts/2022/07/practical-reverse-engineering-exercise-3-page-17/" /><meta property="og:see_also" content="https://lampreylabs.com/posts/2022/07/practical-reverse-engineering-exercise-2-page-17/" /><meta property="og:see_also" content="https://lampreylabs.com/posts/2022/07/practical-reverse-engineering-exercise-1-page-17/" />







    <meta property="article:published_time" content="2022-08-24 00:00:00 &#43;0000 UTC" />










        
<script type="text/javascript" src="https://lampreylabs.com/js/theme.min.c88c7372b7adb5cad2d998e1be999f784624f77dae83e787a732633b5e7f9ec8b69e6ead9eed7ec3da52d0c238579475f12decf747ed4e32b71f54c805c5eef8.js" integrity="sha512-yIxzcrettcrS2ZjhvpmfeEYk932ug&#43;eHpzJjO15/nsi2nm6tnu1&#43;w9pS0MI4V5R18S3s90ftTjK3H1TIBcXu&#43;A=="></script>
    </head>

    
        <body>
    

        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://lampreylabs.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark"> </span>
            <span class="logo__text">\\??\C:</span>
            <span class="logo__cursor" style=
                  "
                   background-color:#d60000;
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://lampreylabs.com/about/">About</a></li><li><a href="https://lampreylabs.com/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>

    <link rel="stylesheet" href="https://lampreylabs.com/highlight/styles/github-dark.min.css">
    <script src="https://lampreylabs.com/highlight/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        7 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://lampreylabs.com/posts/2022/08/practical-reverse-engineering-exercise-1-page-35/">Practical Reverse Engineering - Exercise 1, Page 35</a>
      </h1>

      

      

      

      <div class="post-content">
        <h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#question">Question</a></li>
<li><a href="#answer">Answer</a></li>
</ul>
<h2 id="question">Question</h2>
<p>Repeat the walk-through by yourself. Draw the stack layout, including
parameters and local variables.</p>
<h2 id="answer">Answer</h2>
<p>Here is the <code>VirusTotal</code> link to the malware sample in question:
<a href="https://www.virustotal.com/gui/file/2bef7e6b17643300cd8d98dd90a4c3cb0a051ee03272166c7d9589aa62652f6c/detection">wship4.dll</a></p>
<p>And here is the raw <em>disassembly</em> of the <code>DllMain</code> routine as generated by <code>IDA Pro</code> for reference:</p>
<pre tabindex="0"><code class="language-x86asm" data-lang="x86asm">.text:10001C60                                                  ; =============== S U B R O U T I N E =======================================
.text:10001C60
.text:10001C60                                                  ; Attributes: bp-based frame
.text:10001C60
.text:10001C60                                                  ; BOOL __stdcall DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
.text:10001C60                                                  _DllMain@12     proc near               ; CODE XREF: DllEntryPoint+4B↓p
.text:10001C60
.text:10001C60                                                  pe              = PROCESSENTRY32 ptr -130h
.text:10001C60                                                  var_8           = byte ptr -8
.text:10001C60                                                  hinstDLL        = dword ptr  8
.text:10001C60                                                  fdwReason       = dword ptr  0Ch
.text:10001C60                                                  lpvReserved     = dword ptr  10h
.text:10001C60
.text:10001C60 000 55                                                           push    ebp
.text:10001C61 004 8B EC                                                        mov     ebp, esp
.text:10001C63 004 81 EC 30 01 00 00                                            sub     esp, 130h
.text:10001C69 134 57                                                           push    edi
.text:10001C6A 138 0F 01 4D F8                                                  sidt    fword ptr [ebp+var_8]
.text:10001C6E 138 8B 45 FA                                                     mov     eax, dword ptr [ebp+var_8+2]
.text:10001C71 138 3D 00 F4 03 80                                               cmp     eax, 8003F400h
.text:10001C76 138 76 10                                                        jbe     short loc_10001C88
.text:10001C78 138 3D 00 74 04 80                                               cmp     eax, 80047400h
.text:10001C7D 138 73 09                                                        jnb     short loc_10001C88
.text:10001C7F 138 33 C0                                                        xor     eax, eax
.text:10001C81 138 5F                                                           pop     edi
.text:10001C82 134 8B E5                                                        mov     esp, ebp
.text:10001C84 004 5D                                                           pop     ebp
.text:10001C85 000 C2 0C 00                                                     retn    0Ch
.text:10001C88                                                  ; ---------------------------------------------------------------------------
.text:10001C88
.text:10001C88                                                  loc_10001C88:                           ; CODE XREF: DllMain(x,x,x)+16↑j
.text:10001C88                                                                                          ; DllMain(x,x,x)+1D↑j
.text:10001C88 138 33 C0                                                        xor     eax, eax
.text:10001C8A 138 B9 49 00 00 00                                               mov     ecx, 49h ; &#39;I&#39;
.text:10001C8F 138 8D BD D4 FE FF FF                                            lea     edi, [ebp+pe.cntUsage]
.text:10001C95 138 C7 85 D0 FE FF FF 00 00 00 00                                mov     [ebp+pe.dwSize], 0
.text:10001C9F 138 50                                                           push    eax             ; th32ProcessID
.text:10001CA0 13C 6A 02                                                        push    2               ; dwFlags
.text:10001CA2 140 F3 AB                                                        rep stosd
.text:10001CA4 140 E8 2D 2F 00 00                                               call    CreateToolhelp32Snapshot
.text:10001CA9 138 8B F8                                                        mov     edi, eax
.text:10001CAB 138 83 FF FF                                                     cmp     edi, 0FFFFFFFFh
.text:10001CAE 138 75 09                                                        jnz     short loc_10001CB9
.text:10001CB0 138 33 C0                                                        xor     eax, eax
.text:10001CB2 138 5F                                                           pop     edi
.text:10001CB3 134 8B E5                                                        mov     esp, ebp
.text:10001CB5 004 5D                                                           pop     ebp
.text:10001CB6 000 C2 0C 00                                                     retn    0Ch
.text:10001CB9                                                  ; ---------------------------------------------------------------------------
.text:10001CB9
.text:10001CB9                                                  loc_10001CB9:                           ; CODE XREF: DllMain(x,x,x)+4E↑j
.text:10001CB9 138 8D 85 D0 FE FF FF                                            lea     eax, [ebp+pe]
.text:10001CBF 138 56                                                           push    esi
.text:10001CC0 13C 50                                                           push    eax             ; lppe
.text:10001CC1 140 57                                                           push    edi             ; hSnapshot
.text:10001CC2 144 C7 85 D0 FE FF FF 28 01 00 00                                mov     [ebp+pe.dwSize], 128h
.text:10001CCC 144 E8 FF 2E 00 00                                               call    Process32First
.text:10001CD1 13C 85 C0                                                        test    eax, eax
.text:10001CD3 13C 74 4F                                                        jz      short loc_10001D24
.text:10001CD5 13C 8B 35 C0 50 00 10                                            mov     esi, ds:_stricmp
.text:10001CDB 13C 8D 8D F4 FE FF FF                                            lea     ecx, [ebp+pe.szExeFile]
.text:10001CE1 13C 68 50 7C 00 10                                               push    offset String2  ; &#34;explorer.exe&#34;
.text:10001CE6 140 51                                                           push    ecx             ; String1
.text:10001CE7 144 FF D6                                                        call    esi ; _stricmp
.text:10001CE9 144 83 C4 08                                                     add     esp, 8
.text:10001CEC 13C 85 C0                                                        test    eax, eax
.text:10001CEE 13C 74 26                                                        jz      short loc_10001D16
.text:10001CF0
.text:10001CF0                                                  loc_10001CF0:                           ; CODE XREF: DllMain(x,x,x)+B4↓j
.text:10001CF0 13C 8D 95 D0 FE FF FF                                            lea     edx, [ebp+pe]
.text:10001CF6 13C 52                                                           push    edx             ; lppe
.text:10001CF7 140 57                                                           push    edi             ; hSnapshot
.text:10001CF8 144 E8 CD 2E 00 00                                               call    Process32Next
.text:10001CFD 13C 85 C0                                                        test    eax, eax
.text:10001CFF 13C 74 23                                                        jz      short loc_10001D24
.text:10001D01 13C 8D 85 F4 FE FF FF                                            lea     eax, [ebp+pe.szExeFile]
.text:10001D07 13C 68 50 7C 00 10                                               push    offset String2  ; &#34;explorer.exe&#34;
.text:10001D0C 140 50                                                           push    eax             ; String1
.text:10001D0D 144 FF D6                                                        call    esi ; _stricmp
.text:10001D0F 144 83 C4 08                                                     add     esp, 8
.text:10001D12 13C 85 C0                                                        test    eax, eax
.text:10001D14 13C 75 DA                                                        jnz     short loc_10001CF0
.text:10001D16
.text:10001D16                                                  loc_10001D16:                           ; CODE XREF: DllMain(x,x,x)+8E↑j
.text:10001D16 13C 8B 85 E8 FE FF FF                                            mov     eax, [ebp+pe.th32ParentProcessID]
.text:10001D1C 13C 8B 8D D8 FE FF FF                                            mov     ecx, [ebp+pe.th32ProcessID]
.text:10001D22 13C EB 06                                                        jmp     short loc_10001D2A
.text:10001D24                                                  ; ---------------------------------------------------------------------------
.text:10001D24
.text:10001D24                                                  loc_10001D24:                           ; CODE XREF: DllMain(x,x,x)+73↑j
.text:10001D24                                                                                          ; DllMain(x,x,x)+9F↑j
.text:10001D24 13C 8B 45 0C                                                     mov     eax, [ebp+fdwReason]
.text:10001D27 13C 8B 4D 0C                                                     mov     ecx, [ebp+fdwReason]
.text:10001D2A
.text:10001D2A                                                  loc_10001D2A:                           ; CODE XREF: DllMain(x,x,x)+C2↑j
.text:10001D2A 13C 3B C1                                                        cmp     eax, ecx
.text:10001D2C 13C 5E                                                           pop     esi
.text:10001D2D 138 75 09                                                        jnz     short loc_10001D38
.text:10001D2F 138 33 C0                                                        xor     eax, eax
.text:10001D31 138 5F                                                           pop     edi
.text:10001D32 134 8B E5                                                        mov     esp, ebp
.text:10001D34 004 5D                                                           pop     ebp
.text:10001D35 000 C2 0C 00                                                     retn    0Ch
.text:10001D38                                                  ; ---------------------------------------------------------------------------
.text:10001D38
.text:10001D38                                                  loc_10001D38:                           ; CODE XREF: DllMain(x,x,x)+CD↑j
.text:10001D38 138 8B 45 0C                                                     mov     eax, [ebp+fdwReason]
.text:10001D3B 138 48                                                           dec     eax
.text:10001D3C 138 75 15                                                        jnz     short loc_10001D53
.text:10001D3E 138 6A 00                                                        push    0               ; lpThreadId
.text:10001D40 13C 6A 00                                                        push    0               ; dwCreationFlags
.text:10001D42 140 6A 00                                                        push    0               ; lpParameter
.text:10001D44 144 68 D0 32 00 10                                               push    offset StartAddress ; lpStartAddress
.text:10001D49 148 6A 00                                                        push    0               ; dwStackSize
.text:10001D4B 14C 6A 00                                                        push    0               ; lpThreadAttributes
.text:10001D4D 150 FF 15 20 50 00 10                                            call    ds:CreateThread
.text:10001D53
.text:10001D53                                                  loc_10001D53:                           ; CODE XREF: DllMain(x,x,x)+DC↑j
.text:10001D53 138 B8 01 00 00 00                                               mov     eax, 1
.text:10001D58 138 5F                                                           pop     edi
.text:10001D59 134 8B E5                                                        mov     esp, ebp
.text:10001D5B 004 5D                                                           pop     ebp
.text:10001D5C 000 C2 0C 00                                                     retn    0Ch
.text:10001D5C                                                  _DllMain@12     endp
</code></pre><p>Here&rsquo;s how the stack diagram looks like at the start of the <code>DllMain</code> routine:</p>
<p><img src="https://lampreylabs.com/img/initial-stack-diagram-sample_J.PNG" alt="initial-stack-diagram-sample_J" title="initial-stack-diagram-sample_J"></p>
<p>And here&rsquo;s how the local stack frame looks like after the execution of the function prologue:</p>
<p><img src="https://lampreylabs.com/img/stack-diagram-after-function-prologue-sample_J.PNG" alt="stack-diagram-after-function-prologue-sample_J" title="stack-diagram-after-function-prologue-sample_J"></p>
<p>Note how <code>0x130</code> worth of space is allocated on the stack in what can only be presumed is for storing the local variables. Also, note that the offsets are now relative to the base frame pointer.</p>
<p>We can see from the above disassembly that one of the local variables is a structure of type <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-processentry32?redirectedfrom=MSDN">PROCESSENTRY32</a>(which <code>IDA</code> rather ambiguously has named <code>pe</code>). Now, we know that <code>sizeof(pe) == 0x128</code> bytes but the program allocated <code>0x130</code> bytes worth of space on the stack for local variables. That must mean that the second local variable(<code>var_8</code>) is of size <code>0x8</code> bytes.</p>
<p>A little later into the disassembly just after the function prologue, we can see that <code>var_8</code> is indeed used to store the contents of the <code>IDTR</code> using the <a href="https://namazso.github.io/x86/html/SIDT.html">sidt</a> instruction. In <code>x86</code> <code>nt</code>, the data structure used to represent the contents of the <code>GDT</code> and <code>IDT</code> registers is defined like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0">// 0x8 bytes(sizeof)
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span><span style="color:#f00">typedef</span> <span style="color:#f00">struct</span> _DESCRIPTOR {
</span></span><span style="display:flex;"><span>    USHORT Pad;   <span style="color:#0f0">// 0x0
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>    USHORT Limit; <span style="color:#0f0">// 0x2
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>    ULONG  Base;  <span style="color:#0f0">// 0x4
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>} KDESCRIPTOR, *PKDESCRIPTOR;
</span></span></code></pre></div><p>Ergo, <code>var_8</code> can be inferred to be of type <a href="https://www.vergiliusproject.com/kernels/x86/Windows%207/SP1/_DESCRIPTOR">KDESCRIPTOR</a> which also corroborates our previous size calculation.</p>
<p>So the complete stack layout can be illustrated like so:</p>
<p><img src="https://lampreylabs.com/img/complete-stack-diagram-sample_J.PNG" alt="complete-stack-diagram-sample_J" title="complete-stack-diagram-sample_J"></p>
<p>Finally, we can see a raw <em>decompilation</em> of the above routine using <code>Hex-Rays decompiler</code> on <a href="https://dogbolt.org/">https://dogbolt.org/</a>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ee82ee">char</span> String2[] = <span style="color:#87ceeb">&#34;explorer.exe&#34;</span>; <span style="color:#0f0">// idb
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#f00">__stdcall</span> <span style="color:#ff0">DllMain</span>(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  HANDLE Toolhelp32Snapshot; <span style="color:#0f0">// edi
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>  DWORD th32ParentProcessID; <span style="color:#0f0">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>  DWORD th32ProcessID; <span style="color:#0f0">// ecx
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>  PROCESSENTRY32 pe; <span style="color:#0f0">// [esp+4h] [ebp-130h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>  _WORD v8[<span style="color:#f60">4</span>]; <span style="color:#0f0">// [esp+12Ch] [ebp-8h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"></span>
</span></span><span style="display:flex;"><span>  __sidt(v8);
</span></span><span style="display:flex;"><span>  <span style="color:#f00">if</span> ( *(_DWORD *)&amp;v8[<span style="color:#f60">1</span>] &gt; <span style="color:#f60">0x8003F400</span> &amp;&amp; *(_DWORD *)&amp;v8[<span style="color:#f60">1</span>] &lt; <span style="color:#f60">0x80047400</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#f00">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>  memset(&amp;pe, <span style="color:#f60">0</span>, <span style="color:#f00">sizeof</span>(pe));
</span></span><span style="display:flex;"><span>  Toolhelp32Snapshot = CreateToolhelp32Snapshot(<span style="color:#f60">2u</span>, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f00">if</span> ( Toolhelp32Snapshot == (HANDLE)-<span style="color:#f60">1</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#f00">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>  pe.dwSize = <span style="color:#f60">296</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f00">if</span> ( Process32First(Toolhelp32Snapshot, &amp;pe) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f00">if</span> ( !stricmp(pe.szExeFile, String2) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>LABEL_10:
</span></span><span style="display:flex;"><span>      th32ParentProcessID = pe.th32ParentProcessID;
</span></span><span style="display:flex;"><span>      th32ProcessID = pe.th32ProcessID;
</span></span><span style="display:flex;"><span>      <span style="color:#f00">goto</span> LABEL_12;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f00">while</span> ( Process32Next(Toolhelp32Snapshot, &amp;pe) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f00">if</span> ( !stricmp(pe.szExeFile, String2) )
</span></span><span style="display:flex;"><span>        <span style="color:#f00">goto</span> LABEL_10;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  th32ParentProcessID = fdwReason;
</span></span><span style="display:flex;"><span>  th32ProcessID = fdwReason;
</span></span><span style="display:flex;"><span>LABEL_12:
</span></span><span style="display:flex;"><span>  <span style="color:#f00">if</span> ( th32ParentProcessID == th32ProcessID )
</span></span><span style="display:flex;"><span>    <span style="color:#f00">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f00">if</span> ( fdwReason == <span style="color:#f60">1</span> )
</span></span><span style="display:flex;"><span>    CreateThread(<span style="color:#f60">0</span>, <span style="color:#f60">0</span>, StartAddress, <span style="color:#f60">0</span>, <span style="color:#f60">0</span>, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f00">return</span> <span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div>
      </div>
    </article>

    <hr />

    <div class="post-info">
      
      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        1321 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2022-08-24 05:30
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://lampreylabs.com/posts/2022/08/practical-reverse-engineering-exercise-2-page-35/">
                    <span class="button__icon">←</span>
                    <span class="button__text">Practical Reverse Engineering - Exercise 2, Page 35</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://lampreylabs.com/posts/2022/07/practical-reverse-engineering-exercise-4-page-17/">
                    <span class="button__text">Practical Reverse Engineering - Exercise 4, Page 17</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

  </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            
            
            
            
            <span>Copyright © 2022-present winterknife (@_winterknife_). All rights reserved.</span>
        </div>
    </div>
    
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>Other content copyright of their owners.</span>
        </div>
    </div>
    
</footer>

            
        </div>

        


<script type="text/javascript" src="https://lampreylabs.com/bundle.min.864ac347d062ddaee45e59943b606afed174a525acfa17c863ad38b803d4f4b34523ced48999cb7505d526e80180e1e27b04edd16ad2232fc8ec6f912e394ee6.js" integrity="sha512-hkrDR9Bi3a7kXlmUO2Bq/tF0pSWs&#43;hfIY604uAPU9LNFI87UiZnLdQXVJugBgOHiewTt0WrSIy/I7G&#43;RLjlO5g=="></script>



<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "95b61106ac5648148e2c200c46f66894"}'></script>
    </body>
</html>